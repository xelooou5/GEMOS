#!/usr/bin/env python3
"""
üî• GEM OS - REPOSITORY BACKUP SYSTEM
Auto-backup repository files to GitHub and Gist
"""

import subprocess
import time
import json
import os
from datetime import datetime
from pathlib import Path

class RepositoryBackup:
    def __init__(self):
        self.project_root = Path("/home/runner/work/GEMOS/GEMOS")
        self.github_repo = "https://github.com/xelooou5/gemos.git"
        
    def backup_to_github(self):
        """Push all changes to GitHub"""
        try:
            os.chdir(self.project_root)
            
            # Add all changes
            subprocess.run(["git", "add", "."], check=True)
            
            # Commit with timestamp
            timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            commit_msg = f"üî• REPOSITORY BACKUP - {timestamp} - SYNCHRONIZED FILES"
            subprocess.run(["git", "commit", "-m", commit_msg], check=True)
            
            # Push to GitHub
            subprocess.run(["git", "push", "origin", "main"], check=True)
            
            print(f"‚úÖ GitHub backup successful: {timestamp}")
            return True
            
        except subprocess.CalledProcessError as e:
            print(f"‚ùå GitHub backup failed: {e}")
            return False
            
    def backup_to_gist(self):
        """Create/update Gist with critical files"""
        try:
            critical_files = [
                "gem.py",
                "gem_daemon.py", 
                "HELP.py",
                "voice_system_complete.py",
                "core/stt_module.py",
                "core/tts_module.py",
                "AUTONOMOUS_CONFIG.json",
                "README.md",
                "caretheim/README.md",
                "gem_core/README.md"
            ]
            
            # Create gist content
            gist_data = {
                "description": f"üî• GEM OS Repository Backup - {datetime.now().isoformat()}",
                "public": False,
                "files": {}
            }
            
            for file_path in critical_files:
                full_path = self.project_root / file_path
                if full_path.exists():
                    with open(full_path, 'r', encoding='utf-8') as f:
                        gist_data["files"][file_path.replace("/", "_")] = {
                            "content": f.read()
                        }
            
            # Save gist data for manual upload
            gist_file = self.project_root / "data" / "repository_gist_backup.json"
            gist_file.parent.mkdir(exist_ok=True)
            
            with open(gist_file, 'w') as f:
                json.dump(gist_data, f, indent=2)
                
            print(f"‚úÖ Gist backup prepared: {gist_file}")
            return True
            
        except Exception as e:
            print(f"‚ùå Gist backup failed: {e}")
            return False
            
    def run_repository_backup(self):
        """Run repository backup"""
        print("üî• STARTING REPOSITORY BACKUP SYSTEM")
        print("üíæ SYNCHRONIZED FILES PROTECTION ACTIVE")
        
        try:
            print(f"\n‚è∞ {datetime.now().strftime('%H:%M:%S')} - Running backup...")
            
            # Backup to GitHub
            github_success = self.backup_to_github()
            
            # Backup to Gist
            gist_success = self.backup_to_gist()
            
            if github_success and gist_success:
                print("‚úÖ FULL REPOSITORY BACKUP COMPLETE")
            else:
                print("‚ö†Ô∏è PARTIAL BACKUP - SOME OPERATIONS FAILED")
                
            return github_success and gist_success
            
        except Exception as e:
            print(f"‚ùå Backup error: {e}")
            return False

if __name__ == "__main__":
    backup = RepositoryBackup()
    backup.run_repository_backup()
